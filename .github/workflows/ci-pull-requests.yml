name: Build, smoke test and lint branch

on: [pull_request]

jobs:
  lint:
    name: Units Tests & Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          repository: n8n-io/n8n
          ref: ${{ inputs.branch }}


      - name: Setup pnpm
        uses: pnpm/action-setup@v2.2.4
        with:
          run_install: true

      - name: Build
        run: pnpm build

      - name: Restore cached pnpm modules
        uses: actions/cache@v3
        with:
          path: |
            /github/home/.cache
            /github/home/.pnpm-store
            ./node_modules
            ./packages
          key: ${{ github.sha }}-base:16.18.1-e2e-modules

      - name: Test
        run: pnpm test

      - name: Fetch base branch for `git diff`
        run: git fetch origin ${{ github.event.pull_request.base.ref }}:${{ github.event.pull_request.base.ref }}

      - name: Run ESLint on changes only
        env:
          ESLINT_PLUGIN_DIFF_COMMIT: ${{ github.event.pull_request.base.ref }}
        run: pnpm lint

  e2e-node-16:
    name: E2E [Electron/Node 16]
    uses: ./.github/workflows/e2e-reusable.yml
    if: ${{ !contains(github.event.pull_request.labels.*.name, 'skip-e2e') }}
    needs: [lint]
    with:
      branch: ${{ github.event.pull_request.base.ref }}
      user: ${{ github.event.inputs.user || 'PR User' }}
      spec: ${{ github.event.inputs.spec || 'e2e/0-smoke.cy.ts' }}
      run-env: base:16.18.1
      record: false
      parallel: false
      containers: '[1]'
    secrets:
      CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}
